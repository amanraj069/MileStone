<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Milestones - FreelancePro</title>
    <link rel="stylesheet" href="/css/FreelancerD/milestone.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  </head>
  <body>
    <div class="dashboard-wrapper">
      <%- include('../partials/sidebar', { user: user, activePage: 'payment' }) %>
      <div class="main-content">
        <div class="container">
          <div class="header">
            <h1 class="title">Milestones for Job</h1>
          </div>
          <% if (!job) { %>
            <p>No job found.</p>
          <% } else { %>
            <div class="job-section">
              <h2 class="job-title"><%= job.title %></h2>
              <p><strong>Company:</strong> <%= job.company %></p>
              <div class="progress-card">
                <div class="progress-section">
                  <div class="progress-header">
                    <h3 class="progress-title">Project Completion</h3>
                    <span class="progress-percentage"><%= job.progress.completionPercentage %>%</span>
                  </div>
                  <div class="progress-bar-container">
                    <div class="progress-bar" style="width: <%= job.progress.completionPercentage %>%"></div>
                  </div>
                  <div class="progress-labels">
                    <span>Not Started</span>
                    <span>In Progress</span>
                    <span>Completed</span>
                  </div>
                </div>
                <div class="progress-section">
                  <div class="progress-header">
                    <h3 class="progress-title">Payment Progress</h3>
                    <span class="progress-amount">₹<%= job.progress.payment.paid.toFixed(2) %> of ₹<%= job.progress.payment.total.toFixed(2) %> (<%= job.progress.payment.percentage %>%)</span>
                  </div>
                  <div class="progress-bar-container">
                    <div class="progress-bar" style="width: <%= job.progress.payment.percentage %>%"></div>
                  </div>
                </div>
              </div>
              <div class="milestones-container">
                <% job.milestones.forEach(milestone => { %>
                <div class="milestone-card <%= milestone.status === 'paid' ? 'paid' : milestone.requested ? 'requested' : 'not-paid' %>">
                  <div class="milestone-header">
                    <div class="milestone-info">
                      <h3 class="milestone-title">Milestone #<%= milestone.serialNo %></h3>
                      <p class="milestone-description"><%= milestone.description %></p>
                    </div>
                    <div class="milestone-meta">
                      <span class="milestone-amount">₹<%= milestone.amount.toLocaleString() %></span>
                      <span class="milestone-deadline"><%= milestone.deadline %></span>
                    </div>
                  </div>

                  <!-- Sub-tasks Section -->
                  <% if (milestone.subTasks && milestone.subTasks.length > 0) { %>
                  <div class="subtasks-section">
                    <div class="subtasks-header">
                      <span class="subtasks-title">
                        <i class="fas fa-tasks"></i>
                        Progress Tasks
                      </span>
                      <span class="subtasks-progress">
                        <%= milestone.subTasks.filter(st => st.status === 'completed').length %>/<%= milestone.subTasks.length %> Complete
                      </span>
                    </div>
                    
                    <div class="subtasks-progress-bar">
                      <div class="progress-fill" style="width: <%= milestone.completionPercentage || 0 %>%"></div>
                    </div>

                    <div class="subtasks-list">
                      <% milestone.subTasks.forEach(subTask => { %>
                      <div class="subtask-item <%= subTask.status %>" data-subtask-id="<%= subTask.subTaskId %>">
                        <div class="subtask-checkbox" 
                             onclick="toggleSubTask('<%= job.jobId %>', '<%= milestone.milestoneId %>', '<%= subTask.subTaskId %>', '<%= subTask.status %>')">
                          <% if (subTask.status === 'completed') { %>
                            <i class="fas fa-check"></i>
                          <% } else if (subTask.status === 'in-progress') { %>
                            <i class="fas fa-clock"></i>
                          <% } else { %>
                            <i class="far fa-circle"></i>
                          <% } %>
                        </div>
                        <div class="subtask-content">
                          <span class="subtask-description"><%= subTask.description %></span>
                          <% if (subTask.status === 'completed' && subTask.completedDate) { %>
                            <span class="subtask-date">
                              <i class="fas fa-calendar-check"></i>
                              Completed on <%= new Date(subTask.completedDate).toLocaleDateString() %>
                            </span>
                          <% } %>
                          <% if (subTask.notes) { %>
                            <div class="subtask-notes">
                              <i class="fas fa-sticky-note"></i>
                              <%= subTask.notes %>
                            </div>
                          <% } %>
                        </div>
                        <div class="subtask-actions">
                          <% if (subTask.status !== 'completed') { %>
                            <button class="subtask-action-btn" 
                                    onclick="markInProgress('<%= job.jobId %>', '<%= milestone.milestoneId %>', '<%= subTask.subTaskId %>')"
                                    title="Mark as In Progress">
                              <i class="fas fa-play"></i>
                            </button>
                            <button class="subtask-action-btn complete" 
                                    onclick="markCompleted('<%= job.jobId %>', '<%= milestone.milestoneId %>', '<%= subTask.subTaskId %>')"
                                    title="Mark as Completed">
                              <i class="fas fa-check"></i>
                            </button>
                          <% } %>
                        </div>
                      </div>
                      <% }); %>
                    </div>
                  </div>
                  <% } %>

                  <div class="milestone-actions">
                    <% if (milestone.status === 'paid') { %>
                      <button class="request-btn paid" disabled>
                        <i class="fas fa-check-circle"></i>
                        Paid
                      </button>
                    <% } else if (milestone.requested) { %>
                      <button class="request-btn requested" disabled>
                        <i class="fas fa-clock"></i>
                        Payment Requested
                      </button>
                    <% } else { %>
                      <% 
                        // If milestone has no subtasks, allow direct request
                        // If milestone has subtasks, require 100% completion
                        const canRequestPayment = milestone.subTasks.length === 0 || milestone.completionPercentage >= 100;
                      %>
                      <button class="request-btn" 
                              data-job-id="<%= job.jobId %>"
                              data-milestone-id="<%= milestone.milestoneId %>"
                              data-description="<%= milestone.description %>"
                              data-amount="<%= milestone.amount %>"
                              <%= canRequestPayment ? '' : 'disabled' %>>
                        <%= canRequestPayment ? 'Request Payment' : 'Complete Tasks First' %>
                      </button>
                    <% } %>
                  </div>
                </div>
                <% }) %>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    </div>
    <script src="/js/FreelancerD/milestone.js"></script>
  </body>
</html>
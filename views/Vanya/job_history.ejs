<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Job History - Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f8f9fa;
        color: #333;
      }

      .main-content {
        margin-left: 260px;
        padding: 30px;
        min-height: 100vh;
      }

      .page-header {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        border-left: 4px solid #2563eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .page-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
      }

      .page-subtitle {
        color: #666;
        font-size: 16px;
      }

      .content-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
        margin-bottom: 20px;
      }

      .job-card {
        border: 1px solid #e1e5e9;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        background: white;
        display: flex;
        gap: 20px;
        align-items: flex-start;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .job-card:hover {
        border-color: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(37, 99, 235, 0.15);
      }

      .job-company-logo {
        width: 70px;
        height: 70px;
        border-radius: 12px;
        overflow: hidden;
        flex-shrink: 0;
        border: 2px solid #f1f5f9;
        background: #f8f9fa;
      }

      .job-company-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
      }

      .job-card:hover .job-company-logo img {
        transform: scale(1.05);
      }

      .job-info {
        flex: 1;
      }

      .job-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .job-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin: 0;
        line-height: 1.3;
      }

      .job-company {
        color: #666;
        font-size: 15px;
        margin-bottom: 12px;
        font-weight: 500;
      }

      .job-status {
        padding: 6px 16px;
        border-radius: 25px;
        font-size: 13px;
        font-weight: 600;
        text-transform: capitalize;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .job-status.finished {
        background: #d1fae5;
        color: #065f46;
      }

      .job-status.finished::before {
        content: "✓";
        font-weight: bold;
      }

      .job-status.cancelled,
      .job-status.left {
        background: #fee2e2;
        color: #991b1b;
      }

      .job-status.cancelled::before,
      .job-status.left::before {
        content: "✕";
        font-weight: bold;
      }

      .job-tech {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .tech-tag {
        background: #e0f2fe;
        color: #0369a1;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 500;
        border: 1px solid #bae6fd;
      }

      .job-meta {
        display: flex;
        gap: 20px;
        margin-bottom: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .job-date {
        color: #6b7280;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
      }

      .job-date i {
        color: #2563eb;
      }

      .job-cancel-reason {
        color: #ef4444;
        font-size: 13px;
        font-style: italic;
        margin-top: 10px;
      }

      .job-rating {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }

      .rating-stars {
        display: flex;
        gap: 2px;
      }

      .rating-stars i {
        color: #fbbf24;
        font-size: 14px;
      }

      .rating-score {
        color: #666;
        font-size: 13px;
        font-weight: 500;
      }

      .job-actions {
        flex-shrink: 0;
        text-align: center;
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: center;
        min-width: 120px;
      }

      .see-more-btn {
        background: linear-gradient(45deg, #2563eb, #1e40af);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .see-more-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
      }

      .job-price {
        color: #059669;
        font-weight: 700;
        font-size: 18px;
        padding: 8px 12px;
        background: #ecfdf5;
        border-radius: 8px;
        border: 1px solid #a7f3d0;
      }

      .no-jobs {
        text-align: center;
        padding: 60px;
        color: #666;
      }

      .no-jobs i {
        font-size: 64px;
        color: #cbd5e1;
        margin-bottom: 20px;
        opacity: 0.7;
      }

      .no-jobs h3 {
        color: #374151;
        font-size: 20px;
        margin-bottom: 10px;
      }

      .no-jobs p {
        font-size: 16px;
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-wrapper">
      <!-- Sidebar -->
      <%- include('./partials/sidebar', {activePage: 'job_history', user: user
      || { name: 'User' }}) %>

      <!-- Main Content Area -->
      <div class="main-content">
        <div class="page-header">
          <h1 class="page-title">Job History</h1>
          <p class="page-subtitle">
            View your completed and cancelled projects
          </p>
        </div>

        <div class="content-card">
          <div id="loading-indicator" style="text-align: center; padding: 50px">
            <i
              class="fas fa-spinner fa-spin"
              style="font-size: 24px; color: #2563eb"
            ></i>
            <p style="margin-top: 10px; color: #666">Loading job history...</p>
          </div>

          <div id="jobs-container" style="display: none">
            <!-- Jobs will be dynamically loaded here -->
          </div>

          <div id="no-jobs-message" class="no-jobs" style="display: none">
            <i class="fas fa-history"></i>
            <h3>No job history found</h3>
            <p>You haven't completed any jobs yet.</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Load job history when page loads
      document.addEventListener("DOMContentLoaded", function () {
        loadJobHistory();
      });

      async function loadJobHistory() {
        const loadingIndicator = document.getElementById("loading-indicator");
        const jobsContainer = document.getElementById("jobs-container");
        const noJobsMessage = document.getElementById("no-jobs-message");

        try {
          loadingIndicator.style.display = "block";
          jobsContainer.style.display = "none";
          noJobsMessage.style.display = "none";

          const response = await fetch("/freelancerD/job_history/api");

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          loadingIndicator.style.display = "none";

          if (data.success && data.historyJobs && data.historyJobs.length > 0) {
            renderJobs(data.historyJobs);
            jobsContainer.style.display = "block";
          } else {
            noJobsMessage.style.display = "block";
          }
        } catch (error) {
          console.error("Error loading job history:", error);
          loadingIndicator.style.display = "none";

          // Show error message
          jobsContainer.innerHTML = `
            <div style="text-align: center; padding: 50px; color: #ef4444;">
              <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
              <h3>Error loading job history</h3>
              <p>Unable to load job history. Please refresh the page and try again.</p>
              <button onclick="loadJobHistory()" style="
                margin-top: 15px; 
                padding: 10px 20px; 
                background: #2563eb; 
                color: white; 
                border: none; 
                border-radius: 6px; 
                cursor: pointer;
              ">Retry</button>
            </div>
          `;
          jobsContainer.style.display = "block";
        }
      }

      function renderJobs(jobs) {
        const jobsContainer = document.getElementById("jobs-container");

        const jobsHTML = jobs
          .map((job) => {
            const statusDisplayName =
              job.status === "finished"
                ? "Completed"
                : job.status === "left"
                ? "Left Job"
                : "Cancelled";

            const ratingHTML =
              job.status === "finished" && job.rating > 0
                ? `
            <div class="job-rating">
              <div class="rating-stars">
                ${generateStarRating(job.rating)}
              </div>
              <span class="rating-score">${job.rating.toFixed(1)}/5</span>
            </div>
          `
                : "";

            const cancelReasonHTML =
              job.status === "left"
                ? '<div class="job-cancel-reason">Reason: You left the job</div>'
                : "";

            return `
            <div class="job-card">
              <div class="job-company-logo">
                <img src="${
                  job.logo
                }" alt="Company Logo" onerror="this.src='/assets/company_logo.jpg'" />
              </div>
              <div class="job-info">
                <div class="job-header">
                  <div>
                    <h3 class="job-title">${escapeHtml(job.title)}</h3>
                    <div class="job-company">${escapeHtml(job.company)}</div>
                  </div>
                  <div class="job-status ${job.status}">
                    ${statusDisplayName}
                  </div>
                </div>

                <div class="job-tech">
                  ${job.tech
                    .map(
                      (tech) =>
                        `<span class="tech-tag">${escapeHtml(tech)}</span>`
                    )
                    .join("")}
                </div>

                <div class="job-meta">
                  <div class="job-date">
                    <i class="fas fa-calendar"></i>
                    ${escapeHtml(job.date)}
                  </div>
                </div>

                ${cancelReasonHTML}
                ${ratingHTML}
              </div>

              <div class="job-actions">
                <a href="/jobs/${job.id}" class="see-more-btn">See More</a>
                <div class="job-price">${escapeHtml(job.price)}</div>
              </div>
            </div>
          `;
          })
          .join("");

        jobsContainer.innerHTML = jobsHTML;
      }

      function generateStarRating(rating) {
        let starsHTML = "";
        for (let i = 1; i <= 5; i++) {
          if (i <= Math.floor(rating)) {
            starsHTML += '<i class="fas fa-star"></i>';
          } else if (i === Math.ceil(rating) && rating % 1 !== 0) {
            starsHTML += '<i class="fas fa-star-half-alt"></i>';
          } else {
            starsHTML += '<i class="far fa-star"></i>';
          }
        }
        return starsHTML;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Add refresh functionality
      function refreshJobHistory() {
        loadJobHistory();
      }

      // Add a refresh button to the page header
      document.addEventListener("DOMContentLoaded", function () {
        const pageHeader = document.querySelector(".page-header");
        if (pageHeader) {
          const refreshBtn = document.createElement("button");
          refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
          refreshBtn.style.cssText = `
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
          `;
          refreshBtn.onclick = refreshJobHistory;

          const titleContainer = pageHeader.querySelector("h1").parentNode;
          pageHeader.style.flexDirection = "row";
          pageHeader.appendChild(refreshBtn);
        }
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Job Listings - Admin Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/css/adminD/sidebar.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .main-content {
        margin-left: 260px;
        padding: 2rem;
        min-height: 100vh;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
      }

      .page-header {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 8px 32px rgba(37, 99, 235, 0.3);
      }

      .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        color: #fff !important;
      }

      .page-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 400;
        color: #fff !important;
      }

      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(37, 99, 235, 0.1);
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      }

      .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #2563eb;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        color: #6b7280;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
      }

      .content-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(37, 99, 235, 0.1);
      }

      .search-filter-container {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .search-form {
        display: flex;
        align-items: center;
        background: #f8fafc;
        border-radius: 12px;
        padding: 0.5rem;
        border: 2px solid #e2e8f0;
        transition: all 0.3s ease;
      }

      .search-form:focus-within {
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .search-input {
        flex: 1;
        border: none;
        background: transparent;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        outline: none;
        color: #374151;
      }

      .search-input::placeholder {
        color: #9ca3af;
      }

      .search-button {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
      }

      .search-button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(37, 99, 235, 0.3);
      }

      .clear-search {
        background: #ef4444;
        color: white;
        text-decoration: none;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin-left: 0.5rem;
        transition: all 0.3s ease;
        font-size: 0.9rem;
      }

      .clear-search:hover {
        background: #dc2626;
        transform: scale(1.05);
      }

      .filter-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .filter-btn {
        background: #f1f5f9;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        font-size: 0.9rem;
      }

      .filter-btn:hover,
      .filter-btn.active {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        color: white;
        border-color: #2563eb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }

      .jobs-container {
        display: grid;
        gap: 1.5rem;
      }

      .job-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 1.5rem;
        align-items: center;
      }

      .job-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        border-color: #2563eb;
      }

      .job-card.hidden {
        display: none;
      }

      .company-logo {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        overflow: hidden;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .company-logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .company-logo i {
        font-size: 1.5rem;
        color: #9ca3af;
      }

      .job-card-center {
        flex: 1;
      }

      .job-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
        line-height: 1.4;
      }

      .job-company {
        color: #6b7280;
        font-weight: 500;
        margin-bottom: 0.75rem;
      }

      .job-salary {
        color: #059669;
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.75rem;
      }

      .job-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
      }

      .job-tag {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        color: #3730a3;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .job-details {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        color: #6b7280;
        font-size: 0.9rem;
      }

      .job-detail-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .job-detail-item i {
        color: #9ca3af;
      }

      .job-card-right {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      .applicants-badge {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        min-width: 100px;
      }

      .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-badge.open {
        background: #d1fae5;
        color: #065f46;
      }

      .status-badge.closed {
        background: #fee2e2;
        color: #991b1b;
      }

      .status-badge.paused {
        background: #fef3c7;
        color: #92400e;
      }

      .action-buttons {
        display: flex;
        gap: 0.5rem;
      }

      .btn-view {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        color: white;
        text-decoration: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
      }

      .btn-view:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(37, 99, 235, 0.3);
      }

      .btn-delete {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        padding: 0.75rem;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
      }

      .btn-delete:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
      }

      .no-results {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
      }

      .no-results i {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #d1d5db;
      }

      .no-results p {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
      }

      @media (max-width: 768px) {
        .main-content {
          margin-left: 0;
          padding: 1rem;
        }

        .page-title {
          font-size: 2rem;
        }

        .stats-container {
          grid-template-columns: 1fr;
        }

        .job-card {
          grid-template-columns: 1fr;
          text-align: center;
        }

        .job-details {
          justify-content: center;
        }

        .search-filter-container {
          gap: 1rem;
        }

        .filter-buttons {
          justify-content: center;
        }
      }

      @media (max-width: 1200px) {
        .main-content {
          margin-left: 0;
        }
      }
    </style>
    <style>
      .filter-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .filter-left {
        display: flex;
        gap: 10px;
      }

      .filter-right {
        display: flex;
        align-items: center;
      }

      .feature-select {
        padding: 10px 16px;
        border: 2px solid #e0e7ff;
        border-radius: 8px;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        font-size: 14px;
        font-weight: 500;
        color: #334155;
        cursor: pointer;
        min-width: 180px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        position: relative;
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 12px center;
        background-repeat: no-repeat;
        background-size: 16px;
        padding-right: 40px;
      }

      .feature-select:hover {
        border-color: #3949ab;
        background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
      }

      .feature-select:focus {
        outline: none;
        border-color: #3949ab;
        box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1),
          0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .feature-dropdown {
        position: relative;
        display: flex;
        align-items: center;
      }

      .feature-dropdown::before {
        margin-right: 8px;
        font-size: 16px;
      }

      .feature-checkbox-container {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        background: #f0f8ff;
        border-radius: 4px;
        border: 1px solid #3949ab;
      }

      .feature-checkbox {
        margin: 0;
        cursor: pointer;
      }

      .feature-checkbox-container label {
        font-size: 12px;
        color: #3949ab;
        cursor: pointer;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <%- include('Partials/sidebar', { user: user, activePage: 'job_listings' })
    %>

    <div class="main-content">
      <div class="page-header">
        <div>
          <h1 class="page-title">Job Listings Management</h1>
          <p class="page-subtitle">
            Monitor and manage all job postings across the platform
          </p>
        </div>
      </div>

      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-number"><%= jobs.length %></div>
          <div class="stat-label">Total Jobs</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">
            <%= jobs.filter(job => job.status === 'open').length %>
          </div>
          <div class="stat-label">Active Jobs</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">
            <%= jobs.reduce((sum, job) => sum + (job.applications?.length || 0),
            0) %>
          </div>
          <div class="stat-label">Total Applications</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">
            <%= jobs.filter(job => job.status === 'closed').length %>
          </div>
          <div class="stat-label">Completed Jobs</div>
        </div>
      </div>

      <div class="content-card">
        <div class="search-filter-container">
          <form action="/adminD/job_listings" method="GET" class="search-form">
            <input
              type="text"
              name="q"
              id="searchInput"
              value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
              placeholder="Search by job title, company, or skills..."
              class="search-input"
            />
            <button type="submit" class="search-button">
              <i class="fas fa-search"></i>
            </button>
            <% if (typeof searchQuery !== 'undefined' && searchQuery) { %>
            <a href="/adminD/job_listings" class="clear-search">
              <i class="fas fa-times"></i> Clear
            </a>
            <% } %>
          </form>

          <div class="filter-buttons">
            <div class="filter-left">
              <button class="filter-btn" data-filter="all">All</button>
              <button class="filter-btn" data-filter="open">Open</button>
              <button class="filter-btn" data-filter="closed">Closed</button>
            </div>
            <div class="filter-right">
              <div class="feature-dropdown">
                <select id="featureSelect" class="feature-select">
                  <option value="">Feature Job Post</option>
                  <option value="urgent">Urgent</option>
                  <option value="new">New</option>
                  <option value="high-demand">High Demand</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <div class="jobs-container">
          <% if (jobs.length === 0) { %>
          <div class="no-results">
            <i class="fas fa-briefcase"></i>
            <p>No job listings found.</p>
            <% if (typeof searchQuery !== 'undefined' && searchQuery) { %>
            <p>Try adjusting your search criteria.</p>
            <% } %>
          </div>
          <% } else { %> <% jobs.forEach(job => { %>
          <div class="job-card" data-status="<%= job.status || 'open' %>">
            <div class="company-logo">
              <% if (job.imageUrl) { %>
              <img
                src="<%= job.imageUrl %>"
                alt="Company Logo"
                onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=&quot;fas fa-building&quot;></i>'"
              />
              <% } else { %>
              <i class="fas fa-building"></i>
              <% } %>
            </div>

            <div class="job-card-center">
              <h3 class="job-title"><%= job.title || 'Untitled Job' %></h3>
              <% if (job.companyName) { %>
              <p class="job-company">
                <i class="fas fa-building"></i>
                <%= job.companyName %>
              </p>
              <% } %>
              <p class="job-salary">
                <i class="fas fa-dollar-sign"></i>
                <%= job.formattedBudget || job.budget || 'Budget not specified'
                %>
              </p>

              <% if (job.description && job.description.skills &&
              job.description.skills.length > 0) { %>
              <div class="job-tags">
                <% job.description.skills.slice(0, 4).forEach(skill => { %>
                <span class="job-tag"><%= skill %></span>
                <% }) %> <% if (job.description.skills.length > 4) { %>
                <span class="job-tag"
                  >+<%= job.description.skills.length - 4 %> more</span
                >
                <% } %>
              </div>
              <% } %>

              <div class="job-details">
                <div class="job-detail-item">
                  <i class="fas fa-map-marker-alt"></i>
                  <span><%= job.location || 'Remote' %></span>
                </div>
                <div class="job-detail-item">
                  <i class="fas fa-briefcase"></i>
                  <span><%= job.jobType || 'Full-time' %></span>
                </div>
                <div class="job-detail-item">
                  <i class="fas fa-calendar"></i>
                  <span>Posted <%= job.formattedDate || 'Recently' %></span>
                </div>
                <div class="job-detail-item">
                  <i class="fas fa-clock"></i>
                  <span
                    >Deadline: <%= job.deadline ? new
                    Date(job.deadline).toLocaleDateString() : 'Not specified'
                    %></span
                  >
                </div>
              </div>
            </div>

            <div class="job-card-right">
              <div class="applicants-badge">
                <i class="fas fa-users"></i>
                <%= job.applications?.length || 0 %> applicants
              </div>
              <div
                class="feature-checkbox-container"
                style="display: none; margin: 10px 0"
              >
                <input type="checkbox" class="feature-checkbox" data-job-id="<%=
                job.jobId %>" <%= job.featured && job.featured.isActive ?
                'checked' : '' %> />
                <label>Feature this job</label>
              </div>

              <div class="status-badge <%= job.status || 'open' %>">
                <% if (job.status === 'open' || !job.status) { %>
                <i class="fas fa-circle"></i> Open <% } else if (job.status ===
                'closed') { %> <i class="fas fa-check-circle"></i> Closed <% }
                else if (job.status === 'paused') { %>
                <i class="fas fa-pause-circle"></i> Paused <% } else { %>
                <i class="fas fa-circle"></i> <%= job.status %> <% } %>
              </div>

              <div class="action-buttons">
                <a href="/jobs/<%= job.jobId || job._id %>" class="btn-view">
                  <i class="fas fa-eye"></i>
                  View Details
                </a>
                <button
                  class="btn-delete"
                  onclick="deleteJob('<%= job.jobId || job._id %>')"
                  data-tooltip="Delete Job"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
          <% }) %> <% } %>
        </div>
      </div>
    </div>

    <script src="/js/adminD/job_listings.js"></script>
    <script>
      // Filter buttons functionality
      document.querySelectorAll(".filter-btn").forEach((button) => {
        button.addEventListener("click", () => {
          document
            .querySelectorAll(".filter-btn")
            .forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");

          const filter = button.getAttribute("data-filter");
          document.querySelectorAll(".job-card").forEach((card) => {
            if (
              filter === "all" ||
              card.getAttribute("data-status") === filter
            ) {
              card.classList.remove("hidden");
            } else {
              card.classList.add("hidden");
            }
          });
        });
      });

      // Feature dropdown functionality
      const featureSelect = document.getElementById("featureSelect");
      const checkboxContainers = document.querySelectorAll(
        ".feature-checkbox-container"
      );

      featureSelect.addEventListener("change", function () {
        const selectedValue = this.value;

        if (selectedValue) {
          // Show all checkboxes
          checkboxContainers.forEach((container) => {
            container.style.display = "block";
          });

          // Update all checkboxes data attribute
          document.querySelectorAll(".feature-checkbox").forEach((checkbox) => {
            checkbox.setAttribute("data-feature-type", selectedValue);
          });
        } else {
          // Hide all checkboxes
          checkboxContainers.forEach((container) => {
            container.style.display = "none";
          });
        }
      });

      // Handle checkbox changes
      document.querySelectorAll(".feature-checkbox").forEach((checkbox) => {
        checkbox.addEventListener("change", function () {
          const jobId = this.getAttribute("data-job-id");
          const featureType = this.getAttribute("data-feature-type");
          const isChecked = this.checked;

          // Send AJAX request to update feature status
          fetch("/adminD/jobs/feature", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              jobId: jobId,
              featureType: featureType,
              isActive: isChecked,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log("Job feature status updated successfully");
                // Show correct message for feature/unfeature
                if (isChecked) {
                  showNotification("Job featured successfully!", "success");
                } else {
                  showNotification("Job unfeatured successfully!", "success");
                }
              } else {
                console.error(
                  "Error updating job feature status:",
                  data.message
                );
                // Revert checkbox state
                this.checked = !isChecked;
                showNotification("Error updating job feature status", "error");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              // Revert checkbox state
              this.checked = !isChecked;
              showNotification("Network error occurred", "error");
            });
        });
      });

      // Notification function
      function showNotification(message, type) {
        const notification = document.createElement("div");
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 20px;
          background: ${type === "success" ? "#4CAF50" : "#f44336"};
          color: white;
          border-radius: 4px;
          z-index: 1000;
          font-size: 14px;
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);
      }
    </script>
  </body>
</html>
